{% extends 'base.html' %}
{% load static %}

{% block title %}–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è - –§–æ—Ä—É–º –ø–æ –í—Å–µ–ª–µ–Ω–Ω–æ–π –í–µ–¥—å–º–∞–∫–∞{% endblock %}

{% block content %}
<div class="auth-container">
    <div class="auth-form">

        <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —ç—Ç–∞–ø–æ–≤ -->
        <div class="registration-stages">
            <div class="stage {% if stage == 1 %}active{% endif %}">
                <div class="stage-number">1</div>
                <div class="stage-label">–î–∞–Ω–Ω—ã–µ</div>
            </div>
            <div class="stage-separator">‚Üí</div>
            <div class="stage {% if stage == 2 %}active{% endif %}">
                <div class="stage-number">2</div>
                <div class="stage-label">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</div>
            </div>
        </div>

        <h2>
            {% if stage == 1 %}–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è{% else %}–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ email{% endif %}
        </h2>

        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }}">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}

        {% if stage == 1 %}
        <!-- –≠–¢–ê–ü 1: –§–æ—Ä–º–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ -->
        <form method="post">
            {% csrf_token %}

            <div class="form-group">
                <label for="id_username">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</label>
                <input type="text" id="id_username" name="username" required class="form-control"
                       value="{{ form_data.username|default:'' }}"
                       maxlength="150"
                       autocomplete="username">
                <small class="form-text">–û—Ç 3 –¥–æ 150 —Å–∏–º–≤–æ–ª–æ–≤</small>
            </div>

            <div class="form-group">
                <label for="id_email">Email:</label>
                <input type="email" id="id_email" name="email" required class="form-control"
                       value="{{ form_data.email|default:'' }}"
                       autocomplete="email">
                <small class="form-text">–ù–∞ —ç—Ç–æ—Ç –∞–¥—Ä–µ—Å –ø—Ä–∏–¥–µ—Ç –∫–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è</small>
            </div>

            <div class="form-group">
                <label for="id_password1">–ü–∞—Ä–æ–ª—å:</label>
                <input type="password" id="id_password1" name="password1" required class="form-control"
                       autocomplete="new-password">
                <small class="form-text">–ù–µ –º–µ–Ω–µ–µ 8 —Å–∏–º–≤–æ–ª–æ–≤</small>
            </div>

            <div class="form-group">
                <label for="id_password2">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è:</label>
                <input type="password" id="id_password2" name="password2" required class="form-control"
                       autocomplete="new-password">
                <small class="form-text">–í–≤–µ–¥–∏—Ç–µ —Ç–æ—Ç –∂–µ –ø–∞—Ä–æ–ª—å</small>
            </div>

            <button type="submit" class="btn btn-gold w-100">
                <i class="fas fa-arrow-right"></i> –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å
            </button>
        </form>

        {% elif stage == 2 %}
        <!-- –≠–¢–ê–ü 2: –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∫–æ–¥–∞ -->
        <div class="verification-step">
            <div class="email-display">
                <i class="fas fa-envelope"></i>
                <div class="email-text" title="{{ email }}">
                    –ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞: <span class="email-truncated">{{ email|truncatechars:30 }}</span>
                </div>
            </div>

            <form method="post">
                {% csrf_token %}

                <div class="form-group">
                    <label for="id_code">–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∏–∑ –ø–∏—Å—å–º–∞:</label>
                    <input type="text"
                           id="id_code"
                           name="code"
                           required
                           class="form-control code-input"
                           placeholder="000000"
                           maxlength="6"
                           pattern="[0-9]{6}"
                           autocomplete="off"
                           autofocus
                           value="{{ request.POST.code|default:'' }}">
                    <small class="form-text">6 —Ü–∏—Ñ—Ä –∏–∑ –ø–∏—Å—å–º–∞</small>
                </div>

                <button type="submit" class="btn btn-gold w-100">
                    <i class="fas fa-check-circle"></i> –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∏ –≤–æ–π—Ç–∏
                </button>
            </form>

            <div class="verification-actions">
                <a href="?reset=1" class="btn-action">
                    <i class="fas fa-edit"></i> –ò–∑–º–µ–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
                </a>
                <form method="post" class="inline-form">
                    {% csrf_token %}
                    <button type="submit" name="resend" class="btn-action">
                        <i class="fas fa-redo"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥ —Å–Ω–æ–≤–∞
                    </button>
                </form>
            </div>
        </div>
        {% endif %}

        <div class="auth-links">
            <p>–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? <a href="{% url 'wiki:login' %}">üîê –í–æ–π—Ç–∏</a></p>
            <p>–í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ <a href="{% url 'wiki:home' %}">–≥–ª–∞–≤–Ω—É—é</a></p>
        </div>
    </div>
</div>

<style>
.auth-container {
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 60vh;
    padding: 20px;
}

.auth-form {
    background: linear-gradient(135deg, #2d2d2d 0%, #1a1a1a 100%);
    padding: 40px;
    border-radius: 15px;
    border: 2px solid #D4AF37;
    width: 100%;
    max-width: 450px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.3);
}

.auth-form h2 {
    color: #D4AF37;
    text-align: center;
    margin: 20px 0 30px;
    font-family: 'Cinzel', serif;
    font-size: 1.8em;
}

/* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —ç—Ç–∞–ø–æ–≤ */
.registration-stages {
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 20px;
}

.stage {
    text-align: center;
}

.stage.active .stage-number {
    background: #D4AF37;
    color: #1a1a1a;
    border-color: #D4AF37;
}

.stage.active .stage-label {
    color: #D4AF37;
    font-weight: bold;
}

.stage-number {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    border: 2px solid rgba(212, 175, 55, 0.5);
    color: rgba(212, 175, 55, 0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    margin: 0 auto 8px;
    font-size: 1.1em;
}

.stage-label {
    color: #888;
    font-size: 0.9em;
    white-space: nowrap;
}

.stage-separator {
    color: #D4AF37;
    margin: 0 20px;
    font-size: 1.2em;
    opacity: 0.7;
}

/* –§–æ—Ä–º–∞ */
.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    color: #D4AF37;
    margin-bottom: 8px;
    font-weight: bold;
}

.form-control {
    width: 100%;
    padding: 12px;
    border: 1px solid #444;
    border-radius: 8px;
    background: #1a1a1a;
    color: #e8e8e8;
    font-size: 16px;
    transition: all 0.3s;
}

.form-control:focus {
    outline: none;
    border-color: #D4AF37;
    box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.2);
}

.code-input {
    font-size: 1.8em;
    letter-spacing: 15px;
    text-align: center;
    font-family: monospace;
    height: 70px;
    padding: 15px;
}

/* –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ email */
.email-display {
    background: rgba(59, 130, 246, 0.1);
    border: 1px solid #3b82f6;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 25px;
    display: flex;
    align-items: center;
    gap: 12px;
}

.email-display i {
    color: #3b82f6;
    font-size: 1.5em;
}

.email-text {
    color: #3b82f6;
    font-weight: bold;
    flex: 1;
    word-break: break-all;
    overflow-wrap: break-word;
}

.email-truncated {
    display: inline-block;
    max-width: 100%;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    vertical-align: bottom;
}

.email-text:hover .email-truncated {
    white-space: normal;
    word-break: break-all;
}

/* –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π */
.verification-actions {
    display: flex;
    justify-content: space-between;
    margin-top: 20px;
    gap: 10px;
}

.btn-action {
    background: transparent;
    border: 1px solid #D4AF37;
    color: #D4AF37;
    padding: 10px 15px;
    border-radius: 6px;
    text-decoration: none;
    font-size: 0.9em;
    cursor: pointer;
    transition: all 0.3s;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    flex: 1;
    justify-content: center;
}

.btn-action:hover {
    background: rgba(212, 175, 55, 0.1);
    color: #FFD700;
}

.inline-form {
    display: inline;
    margin: 0;
    padding: 0;
}

.inline-form button {
    background: transparent;
    border: none;
    padding: 0;
    font: inherit;
    cursor: pointer;
    width: 100%;
}

/* –û—Å–Ω–æ–≤–Ω–∞—è –∫–Ω–æ–ø–∫–∞ */
.btn {
    width: 100%;
    padding: 14px;
    background: #D4AF37;
    color: #1a1a1a;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s;
    margin-top: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
}

.btn:hover {
    background: #FFD700;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(212, 175, 55, 0.3);
}

/* –ê–ª–ª–µ—Ä—Ç—ã */
.alert {
    padding: 12px;
    border-radius: 8px;
    margin-bottom: 20px;
    font-weight: bold;
    display: flex;
    align-items: center;
    gap: 10px;
}

.alert-info {
    background: rgba(59, 130, 246, 0.1);
    border: 1px solid #3b82f6;
    color: #3b82f6;
}

.alert-error {
    background: rgba(220, 53, 69, 0.1);
    border: 1px solid #dc3545;
    color: #dc3545;
}

.alert-success {
    background: rgba(40, 167, 69, 0.1);
    border: 1px solid #28a745;
    color: #28a745;
}

/* –°—Å—ã–ª–∫–∏ */
.auth-links {
    text-align: center;
    margin-top: 25px;
    color: #888;
    border-top: 1px solid rgba(212, 175, 55, 0.2);
    padding-top: 20px;
}

.auth-links a {
    color: #D4AF37;
    text-decoration: none;
    font-weight: bold;
    transition: color 0.3s;
}

.auth-links a:hover {
    color: #FFD700;
    text-decoration: underline;
}

.auth-links p {
    margin: 8px 0;
}

/* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
@media (max-width: 480px) {
    .auth-form {
        padding: 25px 15px;
        margin: 10px;
    }

    .auth-form h2 {
        font-size: 1.5em;
        margin: 15px 0 20px;
    }

    .stage-separator {
        margin: 0 10px;
    }

    .stage-label {
        font-size: 0.8em;
    }

    .code-input {
        font-size: 1.5em;
        letter-spacing: 10px;
        height: 60px;
        padding: 12px;
    }

    .verification-actions {
        flex-direction: column;
    }

    .email-display {
        padding: 12px;
        font-size: 0.9em;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // –ê–≤—Ç–æ—Ñ–æ–∫—É—Å –Ω–∞ –∫–æ–¥
    const codeInput = document.getElementById('id_code');
    if (codeInput) {
        codeInput.focus();

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –ø—Ä–∏ –≤–≤–æ–¥–µ 6 —Ü–∏—Ñ—Ä
        codeInput.addEventListener('input', function() {
            if (this.value.length === 6 && /^\d+$/.test(this.value)) {
                this.form.submit();
            }
        });
    }

    // –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–∞—Ä–æ–ª–µ–π
    const password1 = document.getElementById('id_password1');
    const password2 = document.getElementById('id_password2');

    if (password1 && password2) {
        function validatePasswords() {
            if (password1.value && password2.value && password1.value !== password2.value) {
                password2.setCustomValidity('–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç');
                password2.classList.add('is-invalid');
            } else {
                password2.setCustomValidity('');
                password2.classList.remove('is-invalid');
            }
        }

        password1.addEventListener('input', validatePasswords);
        password2.addEventListener('input', validatePasswords);
    }

    // –ü–æ–∫–∞–∑ –ø–æ–ª–Ω–æ–≥–æ email –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏
    const emailDisplay = document.querySelector('.email-text');
    if (emailDisplay) {
        emailDisplay.addEventListener('mouseenter', function() {
            const truncated = this.querySelector('.email-truncated');
            if (truncated) {
                truncated.style.whiteSpace = 'normal';
                truncated.style.wordBreak = 'break-all';
            }
        });

        emailDisplay.addEventListener('mouseleave', function() {
            const truncated = this.querySelector('.email-truncated');
            if (truncated) {
                truncated.style.whiteSpace = 'nowrap';
                truncated.style.wordBreak = 'normal';
                truncated.style.textOverflow = 'ellipsis';
                truncated.style.overflow = 'hidden';
            }
        });
    }
});
</script>
{% endblock %}