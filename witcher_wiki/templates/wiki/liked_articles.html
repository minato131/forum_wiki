{% extends 'base.html' %}
{% load static %}

{% block title %}–ü–æ–Ω—Ä–∞–≤–∏–≤—à–∏–µ—Å—è —Å—Ç–∞—Ç—å–∏ - –§–æ—Ä—É–º –ø–æ –í—Å–µ–ª–µ–Ω–Ω–æ–π –í–µ–¥—å–º–∞–∫–∞{% endblock %}

{% block content %}
<div class="liked-articles-container">
    <div class="page-header">
        <h1>‚ù§Ô∏è –ü–æ–Ω—Ä–∞–≤–∏–≤—à–∏–µ—Å—è —Å—Ç–∞—Ç—å–∏</h1>
        <p class="page-subtitle">–°—Ç–∞—Ç—å–∏, –∫–æ—Ç–æ—Ä—ã–µ –≤–∞–º –ø–æ–Ω—Ä–∞–≤–∏–ª–∏—Å—å</p>
    </div>

    {% if articles %}
    <div class="articles-stats">
        <div class="stat-badge">
            <span class="stat-number">{{ total_count }}</span>
            <span class="stat-label">–≤—Å–µ–≥–æ —Å—Ç–∞—Ç–µ–π</span>
        </div>
    </div>

    <div class="articles-grid">
        {% for article in articles %}
        <div class="article-card liked-article-card">
            <div class="article-header">
                <h3 class="article-title">
                    <a href="{% url 'wiki:article_detail' article.slug %}">{{ article.title }}</a>
                </h3>
                <button class="like-btn active"
                        data-article-id="{{ article.id }}"
                        data-article-title="{{ article.title }}"
                        onclick="confirmUnlike('{{ article.id }}', '{{ article.title|escapejs }}')"
                        title="–£–±—Ä–∞—Ç—å –ª–∞–π–∫">
                    ‚ù§Ô∏è
                </button>
            </div>

            <div class="article-meta">
                <span class="meta-item">
                    üë§ <a href="{% url 'wiki:user_public_profile' article.author.username %}">{{ article.author.username }}</a>
                </span>
                <span class="meta-item">üìÖ {{ article.created_at|date:"d.m.Y" }}</span>
                <span class="meta-item">üëÅÔ∏è {{ article.views_count|default:0 }}</span>
                <span class="meta-item likes-count" data-likes-count="{{ article.id }}">
                    ‚ù§Ô∏è {{ article.likes_count|default:0 }}
                </span>
            </div>

            {% if article.excerpt %}
            <p class="article-excerpt">{{ article.excerpt|truncatewords:30 }}</p>
            {% endif %}

            <div class="article-categories">
                {% for category in article.categories.all %}
                <span class="category-tag">{{ category.name }}</span>
                {% endfor %}
            </div>

            <div class="article-actions">
                <a href="{% url 'wiki:article_detail' article.slug %}" class="btn-read">üìñ –ß–∏—Ç–∞—Ç—å</a>
                <button class="btn-unlike"
                        onclick="confirmUnlike('{{ article.id }}', '{{ article.title|escapejs }}')">
                    üóëÔ∏è –£–±—Ä–∞—Ç—å –ª–∞–π–∫
                </button>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
    {% if articles.has_other_pages %}
    <div class="pagination">
        {% if articles.has_previous %}
            <a href="?page={{ articles.previous_page_number }}" class="page-link">‚Üê –ù–∞–∑–∞–¥</a>
        {% endif %}

        <span class="current-page">
            –°—Ç—Ä–∞–Ω–∏—Ü–∞ {{ articles.number }} –∏–∑ {{ articles.paginator.num_pages }}
        </span>

        {% if articles.has_next %}
            <a href="?page={{ articles.next_page_number }}" class="page-link">–í–ø–µ—Ä–µ–¥ ‚Üí</a>
        {% endif %}
    </div>
    {% endif %}

    {% else %}
    <div class="empty-state">
        <div class="empty-icon">‚ù§Ô∏è</div>
        <h3>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –ø–æ–Ω—Ä–∞–≤–∏–≤—à–∏—Ö—Å—è —Å—Ç–∞—Ç–µ–π</h3>
        <p>–ö–æ–≥–¥–∞ –≤—ã –±—É–¥–µ—Ç–µ —Å—Ç–∞–≤–∏—Ç—å –ª–∞–π–∫–∏ —Å—Ç–∞—Ç—å—è–º, –æ–Ω–∏ –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å.</p>
        <div class="empty-actions">
            <a href="{% url 'wiki:home' %}" class="btn btn-primary">üè† –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
            <a href="{% url 'wiki:search' %}" class="btn btn-outline">üîç –ù–∞–π—Ç–∏ —Å—Ç–∞—Ç—å–∏</a>
        </div>
    </div>
    {% endif %}
</div>

<style>
.liked-articles-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

.page-header {
    text-align: center;
    margin-bottom: 40px;
}

.page-header h1 {
    color: #D4AF37;
    font-family: 'Cinzel', serif;
    font-size: 2.5em;
    margin-bottom: 10px;
}

.page-subtitle {
    color: #e8e8e8;
    font-size: 1.1em;
    opacity: 0.8;
}

.articles-stats {
    display: flex;
    justify-content: center;
    margin-bottom: 30px;
}

.stat-badge {
    background: rgba(220, 53, 69, 0.2);
    border: 2px solid #dc3545;
    border-radius: 20px;
    padding: 10px 20px;
    text-align: center;
}

.stat-number {
    display: block;
    font-size: 1.5em;
    font-weight: bold;
    color: #dc3545;
}

.stat-label {
    font-size: 0.9em;
    color: #e8e8e8;
}

.articles-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 25px;
    margin-bottom: 40px;
}

.article-card {
    background: linear-gradient(135deg, #2d2d2d 0%, #1a1a1a 100%);
    border: 1px solid #444;
    border-radius: 15px;
    padding: 25px;
    transition: all 0.3s ease;
    position: relative;
}

.liked-article-card {
    border-left: 4px solid #dc3545;
}

.article-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 30px rgba(220, 53, 69, 0.2);
    border-color: #dc3545;
}

.article-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 15px;
}

.article-title {
    flex: 1;
    margin: 0;
}

.article-title a {
    color: #D4AF37;
    text-decoration: none;
    font-size: 1.2em;
    line-height: 1.3;
}

.article-title a:hover {
    color: #FFD700;
    text-decoration: underline;
}

.like-btn {
    background: none;
    border: none;
    font-size: 1.5em;
    cursor: pointer;
    padding: 5px;
    border-radius: 50%;
    transition: all 0.3s;
    margin-left: 10px;
}

.like-btn.active {
    color: #dc3545;
}

.like-btn:hover {
    transform: scale(1.2);
}

.article-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    margin-bottom: 15px;
    font-size: 0.85em;
}

.meta-item {
    color: #888;
    display: flex;
    align-items: center;
    gap: 5px;
}

.meta-item a {
    color: #D4AF37;
    text-decoration: none;
}

.meta-item a:hover {
    text-decoration: underline;
}

.article-excerpt {
    color: #e8e8e8;
    line-height: 1.5;
    margin-bottom: 15px;
    font-size: 0.95em;
}

.article-categories {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 20px;
}

.category-tag {
    background: rgba(212, 175, 55, 0.1);
    color: #D4AF37;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 0.8em;
    border: 1px solid #D4AF37;
}

.article-actions {
    display: flex;
    gap: 10px;
    justify-content: space-between;
}

.btn-read {
    background: #D4AF37;
    color: #1a1a1a;
    padding: 8px 16px;
    border-radius: 6px;
    text-decoration: none;
    font-weight: bold;
    transition: all 0.3s;
    flex: 1;
    text-align: center;
}

.btn-read:hover {
    background: #FFD700;
    transform: translateY(-2px);
}

.btn-unlike {
    background: rgba(220, 53, 69, 0.2);
    color: #dc3545;
    border: 1px solid #dc3545;
    padding: 8px 16px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: bold;
    transition: all 0.3s;
    flex: 1;
}

.btn-unlike:hover {
    background: #dc3545;
    color: white;
    transform: translateY(-2px);
}

.pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 15px;
    margin-top: 40px;
}

.page-link {
    background: rgba(212, 175, 55, 0.1);
    color: #D4AF37;
    padding: 10px 20px;
    border-radius: 8px;
    text-decoration: none;
    border: 1px solid #D4AF37;
    transition: all 0.3s;
}

.page-link:hover {
    background: #D4AF37;
    color: #1a1a1a;
}

.current-page {
    color: #e8e8e8;
    font-weight: bold;
}

.empty-state {
    text-align: center;
    padding: 60px 20px;
    background: #2d2d2d;
    border-radius: 15px;
    border: 2px solid #444;
}

.empty-icon {
    font-size: 4em;
    margin-bottom: 20px;
}

.empty-state h3 {
    color: #D4AF37;
    margin-bottom: 15px;
}

.empty-state p {
    color: #e8e8e8;
    margin-bottom: 30px;
    font-size: 1.1em;
}

.empty-actions {
    display: flex;
    gap: 15px;
    justify-content: center;
    flex-wrap: wrap;
}

.btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 12px 25px;
    border-radius: 8px;
    text-decoration: none;
    font-weight: bold;
    transition: all 0.3s;
}

.btn-primary {
    background: #D4AF37;
    color: #1a1a1a;
}

.btn-primary:hover {
    background: #FFD700;
    transform: translateY(-2px);
}

.btn-outline {
    background: transparent;
    color: #D4AF37;
    border: 2px solid #D4AF37;
}

.btn-outline:hover {
    background: #D4AF37;
    color: #1a1a1a;
    transform: translateY(-2px);
}

@media (max-width: 768px) {
    .articles-grid {
        grid-template-columns: 1fr;
    }

    .article-header {
        flex-direction: column;
        gap: 10px;
    }

    .like-btn {
        align-self: flex-end;
    }

    .article-actions {
        flex-direction: column;
    }

    .empty-actions {
        flex-direction: column;
        align-items: center;
    }

    .btn {
        width: 100%;
        justify-content: center;
    }
}
</style>

<script>
// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è –ª–∞–π–∫–∞
function confirmUnlike(articleId, articleTitle) {
    showConfirmationModal(
        `–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–±—Ä–∞—Ç—å –ª–∞–π–∫ —Å–æ —Å—Ç–∞—Ç—å–∏ "${articleTitle}"?`,
        function() {
            removeLike(articleId, articleTitle);
        },
        {
            type: 'danger',
            icon: '‚ù§Ô∏è',
            title: '–£–±—Ä–∞—Ç—å –ª–∞–π–∫',
            confirmText: '–£–±—Ä–∞—Ç—å –ª–∞–π–∫'
        }
    );
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –ª–∞–π–∫–∞ —á–µ—Ä–µ–∑ AJAX
function removeLike(articleId, articleTitle) {
    const likeUrl = `/article/${articleId}/like/`;

    fetch(likeUrl, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json',
        },
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            // –ù–∞—Ö–æ–¥–∏–º –∫–∞—Ä—Ç–æ—á–∫—É —Å—Ç–∞—Ç—å–∏ –∏ —É–¥–∞–ª—è–µ–º –µ—ë
            const articleCard = document.querySelector(`[data-article-id="${articleId}"]`)?.closest('.article-card');
            if (articleCard) {
                // –ê–Ω–∏–º–∞—Ü–∏—è –∏—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏—è
                articleCard.style.transition = 'all 0.3s ease';
                articleCard.style.opacity = '0';
                articleCard.style.transform = 'translateX(100%)';

                setTimeout(() => {
                    articleCard.remove();
                    updateArticlesCount();
                    showToast('–õ–∞–π–∫ —É–±—Ä–∞–Ω', 'success');
                }, 300);
            } else {
                // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –∫–∞—Ä—Ç–æ—á–∫—É, –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
                window.location.reload();
            }
        } else {
            showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ª–∞–π–∫–∞', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ª–∞–π–∫–∞', 'error');
    });
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–∞ —Å—Ç–∞—Ç–µ–π
function updateArticlesCount() {
    const articlesGrid = document.querySelector('.articles-grid');
    const articlesCount = articlesGrid ? articlesGrid.children.length : 0;
    const statNumber = document.querySelector('.stat-number');

    if (statNumber && articlesCount === 0) {
        // –ï—Å–ª–∏ —Å—Ç–∞—Ç–µ–π –Ω–µ –æ—Å—Ç–∞–ª–æ—Å—å, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        showEmptyState();
    } else if (statNumber) {
        statNumber.textContent = articlesCount;
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –ø—É—Å—Ç–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
function showEmptyState() {
    const container = document.querySelector('.liked-articles-container');
    const emptyStateHTML = `
        <div class="empty-state">
            <div class="empty-icon">‚ù§Ô∏è</div>
            <h3>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –ø–æ–Ω—Ä–∞–≤–∏–≤—à–∏—Ö—Å—è —Å—Ç–∞—Ç–µ–π</h3>
            <p>–ö–æ–≥–¥–∞ –≤—ã –±—É–¥–µ—Ç–µ —Å—Ç–∞–≤–∏—Ç—å –ª–∞–π–∫–∏ —Å—Ç–∞—Ç—å—è–º, –æ–Ω–∏ –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å.</p>
            <div class="empty-actions">
                <a href="{% url 'wiki:home' %}" class="btn btn-primary">üè† –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
                <a href="{% url 'wiki:search' %}" class="btn btn-outline">üîç –ù–∞–π—Ç–∏ —Å—Ç–∞—Ç—å–∏</a>
            </div>
        </div>
    `;

    container.innerHTML = emptyStateHTML;
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    // –î–æ–±–∞–≤–ª—è–µ–º data-–∞—Ç—Ä–∏–±—É—Ç—ã –¥–ª—è –∫–Ω–æ–ø–æ–∫ –ª–∞–π–∫–æ–≤
    const likeBtns = document.querySelectorAll('.like-btn');
    likeBtns.forEach(btn => {
        const articleId = btn.getAttribute('data-article-id');
        const articleTitle = btn.closest('.article-card').querySelector('.article-title a').textContent;
        btn.setAttribute('data-article-title', articleTitle);
        btn.onclick = () => confirmUnlike(articleId, articleTitle);
    });
});
</script>
{% endblock %}