{% extends 'base.html' %}
{% load static %}

{% block title %}–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ Telegram | –§–æ—Ä—É–º –ø–æ –í—Å–µ–ª–µ–Ω–Ω–æ–π –í–µ–¥—å–º–∞–∫–∞{% endblock %}

{% block content %}
<div class="telegram-auth-container">
    <div class="telegram-auth-card">
        <div class="telegram-header">
            <div class="telegram-icon">‚öîÔ∏è</div>
            <h1>–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ Telegram</h1>
            <p>–§–æ—Ä—É–º –ø–æ –í—Å–µ–ª–µ–Ω–Ω–æ–π –í–µ–¥—å–º–∞–∫–∞</p>
        </div>

        <div class="auth-content">
            <div class="auth-steps">
                <div class="step active">
                    <div class="step-number">1</div>
                    <div class="step-info">
                        <h3>–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ</h3>
                        <p>–û—Ç–∫—Ä–æ–µ—Ç—Å—è Telegram –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏</p>
                    </div>
                </div>

                <div class="step">
                    <div class="step-number">2</div>
                    <div class="step-info">
                        <h3>–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –≤—Ö–æ–¥</h3>
                        <p>–í –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ Telegram</p>
                    </div>
                </div>

                <div class="step">
                    <div class="step-number">3</div>
                    <div class="step-info">
                        <h3>–ì–æ—Ç–æ–≤–æ!</h3>
                        <p>–í—ã –±—É–¥–µ—Ç–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã</p>
                    </div>
                </div>
            </div>

            <div class="telegram-widget-section">
                <div id="telegram-login-widget">
                    {% if telegram_bot_username and telegram_bot_username != 'your_bot_username' %}
                    <!-- –ó–∞–≥—Ä—É–∑–æ—á–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ -->
                    <div id="widget-loading" style="text-align: center; padding: 30px; color: #D4AF37;">
                        <div style="font-size: 2em; margin-bottom: 15px;">‚è≥</div>
                        <p>–ó–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–∂–µ—Ç–∞ Telegram...</p>
                    </div>
                    {% else %}
                    <div class="alert alert-error">
                        <div style="text-align: center; padding: 20px;">
                            <div style="font-size: 2em; margin-bottom: 10px;">‚ùå</div>
                            <h3>Telegram –±–æ—Ç –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω</h3>
                            <p>–û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞</p>
                            <div style="margin-top: 15px;">
                                <a href="{% url 'wiki:login' %}" class="btn">
                                    üîê –í–æ–π—Ç–∏ –ø–æ –ø–∞—Ä–æ–ª—é
                                </a>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <div class="auth-features">
                <h3>üìã –ß—Ç–æ –≤—ã –ø–æ–ª—É—á–∏—Ç–µ –ø–æ—Å–ª–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:</h3>
                <div class="features-grid">
                    <div class="feature">
                        <span class="feature-icon">‚úçÔ∏è</span>
                        <span class="feature-text">–°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç–∞—Ç–µ–π</span>
                    </div>
                    <div class="feature">
                        <span class="feature-icon">‚ù§Ô∏è</span>
                        <span class="feature-text">–õ–∞–π–∫–∏ –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</span>
                    </div>
                    <div class="feature">
                        <span class="feature-icon">üìö</span>
                        <span class="feature-text">–õ–∏—á–Ω–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞</span>
                    </div>
                    <div class="feature">
                        <span class="feature-icon">üîî</span>
                        <span class="feature-text">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="auth-footer">
            <div class="security-info">
                <div class="security-icon">üîí</div>
                <div class="security-text">
                    <strong>–ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</strong><br>
                    –í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ –∑–∞—â–∏—â–µ–Ω—ã —Å–∫–≤–æ–∑–Ω—ã–º —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ–º
                </div>
            </div>

            <div class="alternative-auth">
                <p>–ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥—Ä—É–≥–æ–π —Å–ø–æ—Å–æ–± –≤—Ö–æ–¥–∞:</p>
                <div class="auth-buttons">
                    <a href="{% url 'wiki:login' %}" class="btn btn-outline">
                        üîê –í–æ–π—Ç–∏ –ø–æ –ø–∞—Ä–æ–ª—é
                    </a>
                    <a href="{% url 'wiki:register' %}" class="btn btn-outline">
                        üìù –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* –°—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è —Ç–∞–∫–∏–º–∏ –∂–µ –∫–∞–∫ –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–º —à–∞–±–ª–æ–Ω–µ */
.telegram-auth-container {
    max-width: 600px;
    margin: 30px auto;
    padding: 20px;
}

.telegram-auth-card {
    background: linear-gradient(135deg, #2d2d2d 0%, #1a1a1a 100%);
    padding: 40px;
    border-radius: 20px;
    border: 2px solid #D4AF37;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
}

.telegram-header {
    text-align: center;
    margin-bottom: 40px;
    border-bottom: 1px solid rgba(212, 175, 55, 0.3);
    padding-bottom: 20px;
}

.telegram-icon {
    font-size: 4em;
    margin-bottom: 15px;
}

.telegram-header h1 {
    color: #D4AF37;
    margin-bottom: 10px;
    font-family: 'Cinzel', serif;
    font-size: 2.2em;
}

.telegram-header p {
    color: #e8e8e8;
    font-size: 1.2em;
    opacity: 0.8;
}

.auth-steps {
    margin-bottom: 40px;
}

.step {
    display: flex;
    align-items: center;
    margin-bottom: 25px;
    padding: 15px;
    border-radius: 10px;
    background: rgba(255, 255, 255, 0.05);
    transition: all 0.3s;
}

.step.active {
    background: rgba(212, 175, 55, 0.1);
    border-left: 4px solid #D4AF37;
}

.step-number {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: #D4AF37;
    color: #1a1a1a;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    margin-right: 20px;
    flex-shrink: 0;
}

.step-info h3 {
    color: #D4AF37;
    margin-bottom: 5px;
    font-size: 1.1em;
}

.step-info p {
    color: #e8e8e8;
    opacity: 0.8;
    margin: 0;
    font-size: 0.9em;
}

.telegram-widget-section {
    text-align: center;
    margin: 40px 0;
    padding: 30px;
    background: rgba(212, 175, 55, 0.05);
    border-radius: 15px;
    border: 1px dashed #D4AF37;
}

.auth-features {
    margin: 40px 0;
}

.auth-features h3 {
    color: #D4AF37;
    text-align: center;
    margin-bottom: 25px;
    font-size: 1.3em;
}

.features-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 15px;
}

.feature {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    padding: 15px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 10px;
    transition: transform 0.3s;
}

.feature:hover {
    transform: translateY(-3px);
    background: rgba(212, 175, 55, 0.1);
}

.feature-icon {
    font-size: 2em;
    margin-bottom: 8px;
}

.feature-text {
    color: #e8e8e8;
    font-size: 0.9em;
    font-weight: 500;
}

.auth-footer {
    border-top: 1px solid rgba(212, 175, 55, 0.3);
    padding-top: 30px;
}

.security-info {
    display: flex;
    align-items: center;
    background: rgba(34, 197, 94, 0.1);
    padding: 15px;
    border-radius: 10px;
    margin-bottom: 25px;
    border: 1px solid rgba(34, 197, 94, 0.3);
}

.security-icon {
    font-size: 2em;
    margin-right: 15px;
}

.security-text {
    color: #e8e8e8;
    font-size: 0.9em;
}

.alternative-auth {
    text-align: center;
}

.alternative-auth p {
    color: #e8e8e8;
    margin-bottom: 15px;
    opacity: 0.8;
}

.auth-buttons {
    display: flex;
    gap: 12px;
    justify-content: center;
    flex-wrap: wrap;
}

.btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 12px 20px;
    background: #D4AF37;
    color: #1a1a1a;
    text-decoration: none;
    border-radius: 8px;
    font-weight: bold;
    transition: all 0.3s;
    border: 2px solid #D4AF37;
    min-width: 150px;
    cursor: pointer;
    border: none;
    font-family: inherit;
}

.btn-outline {
    background: transparent;
    color: #D4AF37;
}

.btn-outline:hover {
    background: #D4AF37;
    color: #1a1a1a;
}

.btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(212, 175, 55, 0.3);
}

.alert-error {
    background: rgba(239, 68, 68, 0.1);
    color: #ef4444;
    padding: 15px;
    border-radius: 8px;
    border: 1px solid #ef4444;
    text-align: center;
}

@media (max-width: 768px) {
    .telegram-auth-container {
        margin: 15px auto;
        padding: 10px;
    }

    .telegram-auth-card {
        padding: 25px 20px;
    }

    .telegram-icon {
        font-size: 3em;
    }

    .telegram-header h1 {
        font-size: 1.8em;
    }

    .step {
        flex-direction: column;
        text-align: center;
    }

    .step-number {
        margin-right: 0;
        margin-bottom: 10px;
    }

    .features-grid {
        grid-template-columns: repeat(2, 1fr);
    }

    .auth-buttons {
        flex-direction: column;
    }

    .btn {
        min-width: auto;
    }
}
</style>

<script>
// –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ Telegram
function onTelegramAuth(user) {
    console.log('Telegram auth data:', user);

    const widget = document.getElementById('telegram-login-widget');
    widget.innerHTML = '<div style="color: #D4AF37; padding: 20px; text-align: center;">‚è≥ –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è...</div>';

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
    const formData = new FormData();
    formData.append('initData', JSON.stringify(user));

    fetch('{% url "wiki:telegram_callback" %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            widget.innerHTML = '<div style="color: #22c55e; padding: 20px; text-align: center;">‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ...</div>';
            setTimeout(() => {
                window.location.href = '{% url "wiki:home" %}';
            }, 1000);
        } else {
            widget.innerHTML = `
                <div style="color: #ef4444; padding: 20px; text-align: center;">
                    ‚ùå –û—à–∏–±–∫–∞: ${data.error}
                    <div style="margin-top: 15px;">
                        <button onclick="initTelegramWidget()" class="btn">üîÑ –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</button>
                    </div>
                </div>
            `;
        }
    })
    .catch(error => {
        widget.innerHTML = `
            <div style="color: #ef4444; padding: 20px; text-align: center;">
                ‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏
                <div style="margin-top: 15px;">
                    <button onclick="initTelegramWidget()" class="btn">üîÑ –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</button>
                </div>
            </div>
        `;
    });
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è fallback –∫–Ω–æ–ø–∫–∏
function createFallbackButton() {
    const widget = document.getElementById('telegram-login-widget');

    const fallbackHtml = `
        <div style="text-align: center; padding: 20px;">
            <div style="margin-bottom: 20px;">
                <div style="font-size: 3em; margin-bottom: 15px;">üì±</div>
                <h3 style="color: #D4AF37; margin-bottom: 10px;">Telegram –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h3>
                <p style="color: #e8e8e8; margin-bottom: 20px;">–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –¥–ª—è –≤—Ö–æ–¥–∞ —á–µ—Ä–µ–∑ Telegram</p>
            </div>

            <button onclick="openTelegramAuth()"
                    class="btn"
                    style="background: #0088cc; color: white; border: none;">
                <span>üîê –í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Telegram</span>
            </button>

            <div style="margin-top: 20px; color: #888; font-size: 0.9em;">
                –ë–æ—Ç: <strong>@{{ telegram_bot_username }}</strong>
            </div>
        </div>
    `;

    widget.innerHTML = fallbackHtml;
}

// –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –º–µ—Ç–æ–¥ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
function openTelegramAuth() {
    const botUsername = '{{ telegram_bot_username }}';
    const webAppUrl = '{{ request.scheme }}://{{ request.get_host }}';

    // –û—Ç–∫—Ä—ã–≤–∞–µ–º —Å—Å—ã–ª–∫—É –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
    const authUrl = `https://t.me/${botUsername}?start=auth_${btoa(webAppUrl).replace(/=/g, '')}`;
    window.open(authUrl, '_blank');

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é
    document.getElementById('telegram-login-widget').innerHTML = `
        <div style="text-align: center; padding: 30px; color: #D4AF37;">
            <div style="font-size: 3em; margin-bottom: 15px;">üì®</div>
            <h3>–û—Ç–∫—Ä—ã—Ç Telegram</h3>
            <p>–ù–∞–∂–º–∏—Ç–µ "START" –≤ –±–æ—Ç–µ –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏</p>
            <div style="margin-top: 20px;">
                <button onclick="initTelegramWidget()"
                        class="btn"
                        style="padding: 10px 20px;">
                    üîÑ –í–µ—Ä–Ω—É—Ç—å—Å—è
                </button>
            </div>
        </div>
    `;
}

// –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –≤–∏–¥–∂–µ—Ç–∞
function initTelegramWidget() {
    const widget = document.getElementById('telegram-login-widget');

    // –°–Ω–∞—á–∞–ª–∞ –ø—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –≤–∏–¥–∂–µ—Ç
    const script = document.createElement('script');
    script.src = 'https://telegram.org/js/telegram-widget.js?22';
    script.async = true;
    script.setAttribute('data-telegram-login', '{{ telegram_bot_username }}');
    script.setAttribute('data-size', 'large');
    script.setAttribute('data-onauth', 'onTelegramAuth(user)');
    script.setAttribute('data-request-access', 'write');

    widget.innerHTML = '<div style="color: #D4AF37; padding: 20px; text-align: center;">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–∂–µ—Ç–∞ Telegram...</div>';
    widget.appendChild(script);

    // –ï—Å–ª–∏ –≤–∏–¥–∂–µ—Ç –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è –∑–∞ 5 —Å–µ–∫—É–Ω–¥, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º fallback
    setTimeout(() => {
        if (!window.Telegram || !widget.querySelector('.telegram-login')) {
            console.log('Telegram widget not loaded, showing fallback');
            createFallbackButton();
        }
    }, 5000);
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    {% if telegram_bot_username and telegram_bot_username != 'your_bot_username' %}
    initTelegramWidget();
    {% endif %}

    // –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è —à–∞–≥–æ–≤
    const steps = document.querySelectorAll('.step');
    steps.forEach((step, index) => {
        setTimeout(() => {
            step.style.opacity = '1';
            step.style.transform = 'translateX(0)';
        }, index * 300);
    });
});
</script>
{% endblock %}