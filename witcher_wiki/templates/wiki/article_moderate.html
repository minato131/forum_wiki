<!-- –°–û–ó–î–ê–¢–¨ –§–ê–ô–õ: templates/wiki/article_moderate.html -->
{% extends 'base.html' %}
{% load static %}

{% block title %}–ú–æ–¥–µ—Ä–∞—Ü–∏—è: {{ article.title }} | –§–æ—Ä—É–º –ø–æ –í—Å–µ–ª–µ–Ω–Ω–æ–π –í–µ–¥—å–º–∞–∫–∞{% endblock %}

{% block content %}
<style>
    .moderation-container {
        max-width: 1000px;
        margin: 0 auto;
        padding: 20px;
    }
    .article-preview {
        background: #2d2d2d;
        border: 1px solid #444;
        border-radius: 10px;
        padding: 25px;
        margin-bottom: 25px;
        max-height: 400px;
        overflow-y: auto;
    }
    .moderation-tools {
        background: rgba(212, 175, 55, 0.1);
        border: 1px solid #D4AF37;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 25px;
    }
    .highlight-tool {
        margin-bottom: 15px;
    }
    .highlight-instruction {
        color: #D4AF37;
        font-size: 0.9em;
        margin-bottom: 10px;
    }
    .text-highlighter {
        background: #1a1a1a;
        border: 1px solid #444;
        border-radius: 5px;
        padding: 10px;
        color: #e8e8e8;
        min-height: 80px;
        margin-bottom: 10px;
    }
    .highlighted-text {
        background: rgba(255, 193, 7, 0.3);
        padding: 2px 4px;
        border-radius: 3px;
        cursor: pointer;
    }
    .moderation-actions {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-top: 25px;
    }
    .action-btn {
        padding: 12px 20px;
        border: none;
        border-radius: 8px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }
    .btn-approve {
        background: #28a745;
        color: white;
    }
    .btn-correction {
        background: #ffc107;
        color: #1a1a1a;
    }
    .btn-editor {
        background: #17a2b8;
        color: white;
    }
    .btn-reject {
        background: #dc3545;
        color: white;
    }
    .action-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    .moderation-comments {
        margin-top: 25px;
    }
    .comment-item {
        background: rgba(255, 193, 7, 0.1);
        border-left: 3px solid #ffc107;
        padding: 15px;
        margin-bottom: 10px;
        border-radius: 5px;
    }
    .comment-text {
        color: #e8e8e8;
        margin-bottom: 5px;
    }
    .comment-meta {
        color: #888;
        font-size: 0.8em;
    }
</style>

<div class="moderation-container">
    <h1 style="color: #D4AF37; text-align: center; margin-bottom: 30px;">
        ‚öñÔ∏è –ú–æ–¥–µ—Ä–∞—Ü–∏—è —Å—Ç–∞—Ç—å–∏
    </h1>

    <div class="article-preview">
        <h2 style="color: #D4AF37; margin-bottom: 15px;">{{ article.title }}</h2>
        <div style="color: #888; margin-bottom: 15px;">
            –ê–≤—Ç–æ—Ä: {{ article.author.username }} |
            –°–æ–∑–¥–∞–Ω–∞: {{ article.created_at|date:"d.m.Y H:i" }}
        </div>
        <div class="article-content">
            {{ article.content|safe }}
        </div>
    </div>

    <!-- –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –≤—ã–¥–µ–ª–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ -->
    <div class="moderation-tools">
        <h3 style="color: #D4AF37; margin-bottom: 15px;">üõ†Ô∏è –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –º–æ–¥–µ—Ä–∞—Ü–∏–∏</h3>

        <div class="highlight-tool">
            <div class="highlight-instruction">
                üìù –í—ã–¥–µ–ª–∏—Ç–µ —Ç–µ–∫—Å—Ç –≤ —Å—Ç–∞—Ç—å–µ –≤—ã—à–µ –∏ –¥–æ–±–∞–≤—å—Ç–µ –∑–∞–º–µ—á–∞–Ω–∏–µ:
            </div>
            <div id="highlightedTextDisplay" class="text-highlighter">
                –í—ã–¥–µ–ª–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å...
            </div>
            <textarea id="moderationComment"
                     placeholder="–í–≤–µ–¥–∏—Ç–µ –∑–∞–º–µ—á–∞–Ω–∏–µ –∫ –≤—ã–¥–µ–ª–µ–Ω–Ω–æ–º—É —Ç–µ–∫—Å—Ç—É..."
                     style="width: 100%; height: 80px; background: #1a1a1a; color: #e8e8e8; border: 1px solid #444; border-radius: 5px; padding: 10px; margin-bottom: 10px;"></textarea>
            <button onclick="addModerationComment()"
                   style="background: #D4AF37; color: #1a1a1a; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer;">
                ‚ûï –î–æ–±–∞–≤–∏—Ç—å –∑–∞–º–µ—á–∞–Ω–∏–µ
            </button>
        </div>
    </div>

    <!-- –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ -->
    {% if moderation_comments %}
    <div class="moderation-comments">
        <h3 style="color: #D4AF37; margin-bottom: 15px;">üìã –ó–∞–º–µ—á–∞–Ω–∏—è –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞</h3>
        {% for comment in moderation_comments %}
        <div class="comment-item">
            <div class="comment-text">
                <strong>–¢–µ–∫—Å—Ç:</strong> "{{ comment.highlighted_text }}"
            </div>
            <div class="comment-text">
                <strong>–ó–∞–º–µ—á–∞–Ω–∏–µ:</strong> {{ comment.comment }}
            </div>
            <div class="comment-meta">
                –î–æ–±–∞–≤–ª–µ–Ω–æ: {{ comment.created_at|date:"d.m.Y H:i" }}
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- –î–µ–π—Å—Ç–≤–∏—è –º–æ–¥–µ—Ä–∞—Ü–∏–∏ -->
    <form method="post" class="moderation-form">
        {% csrf_token %}
        <input type="hidden" id="highlightedCorrections" name="highlighted_corrections">

        <div class="moderation-actions">
            <button type="submit" name="action" value="approve" class="action-btn btn-approve">
                ‚úÖ –û–¥–æ–±—Ä–∏—Ç—å
            </button>
            <button type="submit" name="action" value="needs_correction" class="action-btn btn-correction">
                ‚úèÔ∏è –¢—Ä–µ–±—É–µ—Ç –ø—Ä–∞–≤–æ–∫
            </button>
            <button type="submit" name="action" value="send_to_editor" class="action-btn btn-editor">
                üìù –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–µ–¥–∞–∫—Ç–æ—Ä—É
            </button>
            <button type="submit" name="action" value="reject" class="action-btn btn-reject">
                ‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å
            </button>
        </div>

        <div style="margin-top: 20px;">
            <label style="color: #D4AF37; display: block; margin-bottom: 8px;">
                –û–±—â–∏–µ –∑–∞–º–µ—á–∞–Ω–∏—è:
            </label>
            <textarea name="moderation_notes"
                     style="width: 100%; height: 100px; background: #1a1a1a; color: #e8e8e8; border: 1px solid #444; border-radius: 5px; padding: 10px;"
                     placeholder="–û–±—â–∏–µ –∑–∞–º–µ—á–∞–Ω–∏—è –∫ —Å—Ç–∞—Ç—å–µ..."></textarea>
        </div>
    </form>
</div>

<script>
let currentSelection = null;

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–¥–µ–ª–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ –≤ —Å—Ç–∞—Ç—å–µ
document.addEventListener('selectionchange', function() {
    const selection = window.getSelection();
    if (selection.toString().trim()) {
        currentSelection = selection;
        document.getElementById('highlightedTextDisplay').textContent = selection.toString();
    }
});

function addModerationComment() {
    if (!currentSelection || !currentSelection.toString().trim()) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–¥–µ–ª–∏—Ç–µ —Ç–µ–∫—Å—Ç –≤ —Å—Ç–∞—Ç—å–µ');
        return;
    }

    const comment = document.getElementById('moderationComment').value.trim();
    if (!comment) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∑–∞–º–µ—á–∞–Ω–∏–µ');
        return;
    }

    const range = currentSelection.getRangeAt(0);
    const articleContent = document.querySelector('.article-content');
    const startPosition = getTextPosition(articleContent, range.startContainer, range.startOffset);
    const endPosition = getTextPosition(articleContent, range.endContainer, range.endOffset);

    // –û—Ç–ø—Ä–∞–≤–∫–∞ AJAX –∑–∞–ø—Ä–æ—Å–∞
    const formData = new FormData();
    formData.append('highlighted_text', currentSelection.toString());
    formData.append('comment', comment);
    formData.append('start_position', startPosition);
    formData.append('end_position', endPosition);
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

    fetch('{% url "wiki:add_moderation_comment" article.slug %}', {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('–ó–∞–º–µ—á–∞–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ!');
            document.getElementById('moderationComment').value = '';
            document.getElementById('highlightedTextDisplay').textContent = '–í—ã–¥–µ–ª–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å...';
            currentSelection = null;
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
            location.reload();
        } else {
            alert('–û—à–∏–±–∫–∞: ' + data.error);
        }
    });
}

function getTextPosition(container, node, offset) {
    // –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏–∏ –≤ —Ç–µ–∫—Å—Ç–µ
    const walker = document.createTreeWalker(
        container,
        NodeFilter.SHOW_TEXT,
        null,
        false
    );

    let position = 0;
    let found = false;

    while (walker.nextNode()) {
        const textNode = walker.currentNode;
        if (textNode === node) {
            position += offset;
            found = true;
            break;
        }
        position += textNode.textContent.length;
    }

    return found ? position : -1;
}

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤—ã–¥–µ–ª–µ–Ω–Ω—ã—Ö –ø—Ä–∞–≤–æ–∫ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ñ–æ—Ä–º—ã
document.querySelector('.moderation-form').addEventListener('submit', function() {
    const corrections = [];
    document.querySelectorAll('.comment-item').forEach(item => {
        corrections.push({
            text: item.querySelector('strong:first-child').nextSibling.textContent.replace(/^: "/, '').replace(/"$/, ''),
            comment: item.querySelector('strong:last-child').nextSibling.textContent
        });
    });
    document.getElementById('highlightedCorrections').value = JSON.stringify(corrections);
});
</script>
{% endblock %}