<!-- article_moderate.html - –û–ë–ù–û–í–ò–¢–¨ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ñ–∞–π–ª -->
{% extends 'base.html' %}
{% load static %}

{% block title %}–ú–æ–¥–µ—Ä–∞—Ü–∏—è: {{ article.title }} | –§–æ—Ä—É–º –ø–æ –í—Å–µ–ª–µ–Ω–Ω–æ–π –í–µ–¥—å–º–∞–∫–∞{% endblock %}

{% block content %}
<style>
    .moderation-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }

    .article-preview {
        background: #2d2d2d;
        border: 1px solid #444;
        border-radius: 10px;
        padding: 25px;
        margin-bottom: 25px;
        max-height: 500px;
        overflow-y: auto;
    }

    .moderation-tools {
        background: rgba(212, 175, 55, 0.1);
        border: 1px solid #D4AF37;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 25px;
    }

    .highlight-instruction {
        color: #D4AF37;
        font-size: 0.9em;
        margin-bottom: 10px;
    }

    .text-highlighter {
        background: #1a1a1a;
        border: 1px solid #444;
        border-radius: 5px;
        padding: 10px;
        color: #e8e8e8;
        min-height: 60px;
        margin-bottom: 10px;
        font-style: italic;
    }

    .highlighted-text {
        background: rgba(255, 193, 7, 0.3);
        padding: 2px 4px;
        border-radius: 3px;
        cursor: pointer;
        border: 1px dashed #ffc107;
    }

    .moderation-actions {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-top: 25px;
    }

    .action-btn {
        padding: 12px 20px;
        border: none;
        border-radius: 8px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        font-size: 1em;
    }

    .btn-approve { background: #28a745; color: white; }
    .btn-correction { background: #ffc107; color: #1a1a1a; }
    .btn-editor { background: #17a2b8; color: white; }
    .btn-reject { background: #dc3545; color: white; }

    .action-btn:hover { transform: translateY(-2px); }

    .comment-item {
        background: rgba(255, 193, 7, 0.1);
        border-left: 3px solid #ffc107;
        padding: 15px;
        margin-bottom: 10px;
        border-radius: 5px;
    }

    .article-info {
        background: rgba(212, 175, 55, 0.1);
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
    }
</style>

<div class="moderation-container">
    <h1 style="color: #D4AF37; text-align: center; margin-bottom: 30px;">
        ‚öñÔ∏è –ú–æ–¥–µ—Ä–∞—Ü–∏—è —Å—Ç–∞—Ç—å–∏
    </h1>

    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å—Ç–∞—Ç—å–µ -->
    <div class="article-info">
        <h2 style="color: #D4AF37; margin: 0;">{{ article.title }}</h2>
        <div style="color: #888; margin-top: 10px;">
            üë§ –ê–≤—Ç–æ—Ä: {{ article.author.username }} |
            üìÖ –°–æ–∑–¥–∞–Ω–∞: {{ article.created_at|date:"d.m.Y H:i" }} |
            üè∑Ô∏è –ö–∞—Ç–µ–≥–æ—Ä–∏–∏: {% for category in article.categories.all %}{{ category.name }}{% if not forloop.last %}, {% endif %}{% endfor %}
        </div>
    </div>

    <!-- –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Å—Ç–∞—Ç—å–∏ -->
    <div class="article-preview">
        <h3 style="color: #D4AF37; margin-bottom: 15px;">üìñ –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ —Å—Ç–∞—Ç—å–∏:</h3>
        <div class="article-content" id="articleContent">
            {{ article.content|safe }}
        </div>
    </div>

    <!-- –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –≤—ã–¥–µ–ª–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ -->
    <div class="moderation-tools">
        <h3 style="color: #D4AF37; margin-bottom: 15px;">üõ†Ô∏è –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –º–æ–¥–µ—Ä–∞—Ü–∏–∏</h3>

        <div class="highlight-tool">
            <div class="highlight-instruction">
                üìù <strong>–ö–∞–∫ —Ä–∞–±–æ—Ç–∞—Ç—å:</strong> –í—ã–¥–µ–ª–∏—Ç–µ —Ç–µ–∫—Å—Ç –≤ —Å—Ç–∞—Ç—å–µ –≤—ã—à–µ ‚Üí –¥–æ–±–∞–≤—å—Ç–µ –∑–∞–º–µ—á–∞–Ω–∏–µ ‚Üí –Ω–∞–∂–º–∏—Ç–µ "–î–æ–±–∞–≤–∏—Ç—å –∑–∞–º–µ—á–∞–Ω–∏–µ"
            </div>
            <div id="highlightedTextDisplay" class="text-highlighter">
                –í—ã–¥–µ–ª–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å...
            </div>
            <textarea id="moderationComment"
                     placeholder="–í–≤–µ–¥–∏—Ç–µ –∑–∞–º–µ—á–∞–Ω–∏–µ –∫ –≤—ã–¥–µ–ª–µ–Ω–Ω–æ–º—É —Ç–µ–∫—Å—Ç—É..."
                     style="width: 100%; height: 80px; background: #1a1a1a; color: #e8e8e8; border: 1px solid #444; border-radius: 5px; padding: 10px; margin-bottom: 10px;"></textarea>
            <button onclick="addModerationComment()"
                   style="background: #D4AF37; color: #1a1a1a; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold;">
                ‚ûï –î–æ–±–∞–≤–∏—Ç—å –∑–∞–º–µ—á–∞–Ω–∏–µ
            </button>
        </div>
    </div>

    <!-- –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ -->
    {% if moderation_comments %}
    <div class="moderation-comments">
        <h3 style="color: #D4AF37; margin-bottom: 15px;">
            üìã –ó–∞–º–µ—á–∞–Ω–∏—è –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞ ({{ moderation_comments|length }})
        </h3>
        {% for comment in moderation_comments %}
        <div class="comment-item">
            <div style="color: #ffc107; margin-bottom: 8px;">
                <strong>üìç –í—ã–¥–µ–ª–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç:</strong>
            </div>
            <div style="background: rgba(255,255,255,0.05); padding: 8px; border-radius: 3px; margin-bottom: 10px; font-style: italic;">
                "{{ comment.highlighted_text }}"
            </div>
            <div style="color: #e8e8e8; margin-bottom: 5px;">
                <strong>üí¨ –ó–∞–º–µ—á–∞–Ω–∏–µ:</strong> {{ comment.comment }}
            </div>
            <div style="color: #888; font-size: 0.8em;">
                üìÖ –î–æ–±–∞–≤–ª–µ–Ω–æ: {{ comment.created_at|date:"d.m.Y H:i" }}
                {% if comment.resolved %}
                | ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: {{ comment.resolved_at|date:"d.m.Y H:i" }}
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- –î–µ–π—Å—Ç–≤–∏—è –º–æ–¥–µ—Ä–∞—Ü–∏–∏ -->
    <form method="post" class="moderation-form">
        {% csrf_token %}
        <input type="hidden" id="highlightedCorrections" name="highlighted_corrections">

        <div style="margin-bottom: 20px;">
            <label style="color: #D4AF37; display: block; margin-bottom: 8px; font-weight: bold;">
                üìù –û–±—â–∏–µ –∑–∞–º–µ—á–∞–Ω–∏—è –∫ —Å—Ç–∞—Ç—å–µ:
            </label>
            <textarea name="moderation_notes"
                     style="width: 100%; height: 100px; background: #1a1a1a; color: #e8e8e8; border: 1px solid #444; border-radius: 5px; padding: 10px;"
                     placeholder="–û–±—â–∏–µ –∑–∞–º–µ—á–∞–Ω–∏—è, —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏, –ø–æ—è—Å–Ω–µ–Ω–∏—è...">{{ article.moderation_notes }}</textarea>
        </div>

        <div class="moderation-actions">
            <button type="submit" name="action" value="approve" class="action-btn btn-approve">
                ‚úÖ –û–¥–æ–±—Ä–∏—Ç—å –∏ –æ–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å
            </button>
            <button type="submit" name="action" value="needs_correction" class="action-btn btn-correction">
                ‚úèÔ∏è –¢—Ä–µ–±—É–µ—Ç –ø—Ä–∞–≤–æ–∫
            </button>
            <button type="submit" name="action" value="send_to_editor" class="action-btn btn-editor">
                üìù –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–µ–¥–∞–∫—Ç–æ—Ä—É
            </button>
            <button type="submit" name="action" value="reject" class="action-btn btn-reject">
                ‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å
            </button>
        </div>
    </form>
</div>

<script>
let currentSelection = null;
let highlights = [];

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–¥–µ–ª–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ –≤ —Å—Ç–∞—Ç—å–µ
document.addEventListener('selectionchange', function() {
    const selection = window.getSelection();
    if (selection.toString().trim()) {
        currentSelection = selection;
        document.getElementById('highlightedTextDisplay').textContent = selection.toString();

        // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –≤—ã–¥–µ–ª–µ–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
        highlightSelectedText(selection);
    }
});

function highlightSelectedText(selection) {
    // –í—Ä–µ–º–µ–Ω–Ω–∞—è –ø–æ–¥—Å–≤–µ—Ç–∫–∞ –≤—ã–¥–µ–ª–µ–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
    const range = selection.getRangeAt(0);
    const selectedText = range.extractContents();
    const span = document.createElement('span');
    span.style.backgroundColor = 'rgba(255, 193, 7, 0.3)';
    span.style.border = '1px dashed #ffc107';
    span.style.borderRadius = '2px';
    span.appendChild(selectedText);
    range.insertNode(span);
}

function addModerationComment() {
    if (!currentSelection || !currentSelection.toString().trim()) {
        alert('‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–¥–µ–ª–∏—Ç–µ —Ç–µ–∫—Å—Ç –≤ —Å—Ç–∞—Ç—å–µ');
        return;
    }

    const comment = document.getElementById('moderationComment').value.trim();
    if (!comment) {
        alert('‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∑–∞–º–µ—á–∞–Ω–∏–µ');
        return;
    }

    const highlightedText = currentSelection.toString();

    // –û—Ç–ø—Ä–∞–≤–∫–∞ AJAX –∑–∞–ø—Ä–æ—Å–∞
    const formData = new FormData();
    formData.append('highlighted_text', highlightedText);
    formData.append('comment', comment);
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

    fetch('{% url "wiki:add_moderation_comment" article.slug %}', {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('‚úÖ –ó–∞–º–µ—á–∞–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ!');
            document.getElementById('moderationComment').value = '';
            document.getElementById('highlightedTextDisplay').textContent = '–í—ã–¥–µ–ª–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å...';
            currentSelection = null;
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
            location.reload();
        } else {
            alert('‚ùå –û—à–∏–±–∫–∞: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–º–µ—á–∞–Ω–∏—è');
    });
}

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤—ã–¥–µ–ª–µ–Ω–Ω—ã—Ö –ø—Ä–∞–≤–æ–∫ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ñ–æ—Ä–º—ã
document.querySelector('.moderation-form').addEventListener('submit', function() {
    const corrections = [];
    document.querySelectorAll('.comment-item').forEach(item => {
        const textElement = item.querySelector('div[style*="background: rgba(255,255,255,0.05)"]');
        const commentElement = item.querySelector('div[style*="color: #e8e8e8"]');

        if (textElement && commentElement) {
            const text = textElement.textContent.replace(/^"|"$/g, '').trim();
            const comment = commentElement.textContent.replace('üí¨ –ó–∞–º–µ—á–∞–Ω–∏–µ:', '').trim();

            corrections.push({
                text: text,
                comment: comment
            });
        }
    });

    document.getElementById('highlightedCorrections').value = JSON.stringify(corrections);
});
</script>
{% endblock %}