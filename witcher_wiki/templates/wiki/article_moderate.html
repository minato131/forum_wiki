{% extends 'base.html' %}
{% load static %}

{% block title %}–ú–æ–¥–µ—Ä–∞—Ü–∏—è: {{ article.title }} | –§–æ—Ä—É–º –ø–æ –í—Å–µ–ª–µ–Ω–Ω–æ–π –í–µ–¥—å–º–∞–∫–∞{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&display=swap" rel="stylesheet">
<style>
    :root {
        --gold: #D4AF37;
        --dark-gold: #b8941f;
        --dark-bg: #1a1a1a;
        --darker-bg: #0f0f0f;
        --card-bg: #2d2d2d;
        --border: #444;
        --text: #e8e8e8;
        --text-muted: #888;
        --success: #22c55e;
        --warning: #f59e0b;
        --error: #ef4444;
        --info: #3b82f6;
    }

    .moderation-layout {
        display: grid;
        grid-template-columns: 1fr 400px;
        gap: 30px;
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
        min-height: 100vh;
    }

    @media (max-width: 1200px) {
        .moderation-layout {
            grid-template-columns: 1fr;
            gap: 20px;
        }
    }

    /* Header */
    .moderation-header {
        grid-column: 1 / -1;
        background: linear-gradient(135deg, var(--dark-bg) 0%, var(--darker-bg) 100%);
        border: 2px solid var(--gold);
        border-radius: 20px;
        padding: 30px;
        margin-bottom: 20px;
        position: relative;
        overflow: hidden;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }

    .moderation-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, var(--gold) 0%, #FFD700 50%, var(--gold) 100%);
    }

    .article-title {
        color: var(--gold);
        font-family: 'Cinzel', serif;
        font-size: 2.4em;
        font-weight: 700;
        margin-bottom: 15px;
        text-align: center;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
    }

    .article-meta-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }

    .meta-card {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 15px;
        text-align: center;
        transition: all 0.3s ease;
    }

    .meta-card:hover {
        border-color: var(--gold);
        transform: translateY(-2px);
    }

    .meta-icon {
        font-size: 1.5em;
        color: var(--gold);
        margin-bottom: 8px;
    }

    .meta-label {
        color: var(--text-muted);
        font-size: 0.85em;
        margin-bottom: 5px;
    }

    .meta-value {
        color: var(--text);
        font-weight: 600;
        font-size: 1em;
    }

    /* Content Panel */
    .content-panel {
        background: var(--card-bg);
        border: 1px solid var(--border);
        border-radius: 20px;
        padding: 30px;
        display: flex;
        flex-direction: column;
        height: fit-content;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
    }

    .content-controls {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 25px;
        padding: 20px;
        background: linear-gradient(135deg, rgba(212, 175, 55, 0.1) 0%, rgba(212, 175, 55, 0.05) 100%);
        border-radius: 15px;
        border: 1px solid rgba(212, 175, 55, 0.3);
    }

    .highlight-controls {
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .toggle-highlight {
        background: var(--gold);
        color: var(--dark-bg);
        border: none;
        padding: 12px 24px;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 10px;
        transition: all 0.3s ease;
        font-size: 1em;
    }

    .toggle-highlight:hover {
        background: var(--dark-gold);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(212, 175, 55, 0.4);
    }

    .toggle-highlight.active {
        background: var(--success);
        color: white;
    }

    .highlight-status {
        color: var(--text-muted);
        font-size: 0.95em;
        font-weight: 500;
    }

    .content-area {
        background: var(--dark-bg);
        border: 2px solid var(--border);
        border-radius: 15px;
        padding: 30px;
        min-height: 600px;
        max-height: 70vh;
        overflow-y: auto;
        line-height: 1.8;
        font-size: 1.1em;
        transition: all 0.3s ease;
    }

    .content-area.highlight-mode {
        border-color: var(--gold);
        box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.2);
    }

    /* Progress Section */
    .progress-section {
        margin-top: 25px;
        padding: 20px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 15px;
        border: 1px solid var(--border);
    }

    .progress-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }

    .progress-title {
        color: var(--gold);
        font-weight: 600;
        font-size: 1.1em;
    }

    .progress-bar {
        height: 8px;
        background: var(--dark-bg);
        border-radius: 4px;
        overflow: hidden;
        margin-bottom: 10px;
    }

    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--gold) 0%, #FFD700 100%);
        transition: width 0.5s ease;
        border-radius: 4px;
    }

    .progress-text {
        display: flex;
        justify-content: space-between;
        color: var(--text-muted);
        font-size: 0.9em;
    }

    /* Sidebar */
    .sidebar {
        display: flex;
        flex-direction: column;
        gap: 25px;
        height: fit-content;
        position: sticky;
        top: 20px;
    }

    .sidebar-section {
        background: var(--card-bg);
        border: 1px solid var(--border);
        border-radius: 20px;
        padding: 25px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
    }

    .section-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid rgba(212, 175, 55, 0.3);
    }

    .section-icon {
        color: var(--gold);
        font-size: 1.3em;
    }

    .section-title {
        color: var(--gold);
        font-family: 'Cinzel', serif;
        font-size: 1.4em;
        font-weight: 600;
        margin: 0;
    }

    .section-badge {
        background: var(--gold);
        color: var(--dark-bg);
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.8em;
        font-weight: 700;
    }

    /* Comment Form */
    .comment-form {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    .form-group {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .form-label {
        color: var(--gold);
        font-weight: 600;
        font-size: 0.95em;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .form-control {
        background: var(--dark-bg);
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 14px;
        color: var(--text);
        font-size: 1em;
        resize: vertical;
        transition: all 0.3s ease;
        font-family: inherit;
    }

    .form-control:focus {
        outline: none;
        border-color: var(--gold);
        box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.2);
    }

    textarea.form-control {
        min-height: 120px;
    }

    .selected-text-preview {
        background: rgba(212, 175, 55, 0.1);
        border: 1px solid rgba(212, 175, 55, 0.3);
        border-radius: 10px;
        padding: 15px;
        font-size: 0.95em;
        min-height: 80px;
        max-height: 150px;
        overflow-y: auto;
        color: var(--text);
        font-style: italic;
        line-height: 1.5;
    }

    /* Severity Selector */
    .severity-selector {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
    }

    .severity-option {
        padding: 15px;
        border: 2px solid var(--border);
        border-radius: 10px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 0.9em;
        font-weight: 600;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }

    .severity-option:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .severity-option.selected {
        border-color: currentColor;
        background: rgba(255, 255, 255, 0.1);
    }

    .severity-low { color: #6b7280; }
    .severity-medium { color: #f59e0b; }
    .severity-high { color: #ef4444; }
    .severity-critical { color: #dc2626; }

    /* Comments List */
    .comments-list {
        display: flex;
        flex-direction: column;
        gap: 20px;
        max-height: 500px;
        overflow-y: auto;
        padding-right: 5px;
    }

    .comments-list::-webkit-scrollbar {
        width: 6px;
    }

    .comments-list::-webkit-scrollbar-track {
        background: var(--dark-bg);
        border-radius: 3px;
    }

    .comments-list::-webkit-scrollbar-thumb {
        background: var(--gold);
        border-radius: 3px;
    }

    .comment-item {
        background: var(--dark-bg);
        border: 1px solid var(--border);
        border-radius: 15px;
        padding: 20px;
        transition: all 0.3s ease;
        position: relative;
    }

    .comment-item:hover {
        border-color: var(--gold);
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    }

    .comment-item.resolved {
        opacity: 0.8;
        background: rgba(34, 197, 94, 0.05);
        border-color: var(--success);
    }

    .comment-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }

    .comment-severity {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.85em;
        font-weight: 600;
        padding: 6px 12px;
        border-radius: 8px;
        background: rgba(255,255,255,0.1);
    }

    .comment-text {
        color: var(--text);
        margin-bottom: 15px;
        line-height: 1.6;
    }

    .comment-context {
        color: var(--text-muted);
        font-size: 0.9em;
        font-style: italic;
        margin-bottom: 15px;
        padding: 12px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 8px;
        border-left: 4px solid var(--gold);
    }

    .comment-meta {
        color: var(--text-muted);
        font-size: 0.85em;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .comment-actions {
        display: flex;
        gap: 10px;
        margin-top: 15px;
    }

    .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 8px;
        font-size: 0.85em;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 6px;
        font-weight: 600;
    }

    .btn-resolve {
        background: rgba(34, 197, 94, 0.2);
        color: #22c55e;
        border: 1px solid #22c55e;
    }

    .btn-resolve:hover {
        background: #22c55e;
        color: white;
    }

    .btn-delete {
        background: rgba(239, 68, 68, 0.2);
        color: #ef4444;
        border: 1px solid #ef4444;
    }

    .btn-delete:hover {
        background: #ef4444;
        color: white;
    }

    /* Moderation Actions */
    .moderation-actions {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    .action-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        padding: 16px 24px;
        border: none;
        border-radius: 12px;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        font-size: 1em;
        text-align: center;
    }

    .btn-approve {
        background: linear-gradient(135deg, #22c55e, #16a34a);
        color: white;
    }

    .btn-approve:hover {
        background: linear-gradient(135deg, #16a34a, #15803d);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(34, 197, 94, 0.4);
    }

    .btn-reject {
        background: linear-gradient(135deg, #ef4444, #dc2626);
        color: white;
    }

    .btn-reject:hover {
        background: linear-gradient(135deg, #dc2626, #b91c1c);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
    }

    .btn-correction {
        background: linear-gradient(135deg, #f59e0b, #d97706);
        color: white;
    }

    .btn-correction:hover {
        background: linear-gradient(135deg, #d97706, #b45309);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(245, 158, 11, 0.4);
    }

    .btn-editor {
        background: linear-gradient(135deg, #3b82f6, #2563eb);
        color: white;
    }

    .btn-editor:hover {
        background: linear-gradient(135deg, #2563eb, #1d4ed8);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
    }

    /* Stats */
    .stats-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-top: 15px;
    }

    .stat-item {
        text-align: center;
        padding: 20px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 12px;
        border: 1px solid var(--border);
        transition: all 0.3s ease;
    }

    .stat-item:hover {
        border-color: var(--gold);
        transform: translateY(-2px);
    }

    .stat-number {
        color: var(--gold);
        font-weight: bold;
        font-size: 2em;
        margin-bottom: 8px;
    }

    .stat-label {
        color: var(--text-muted);
        font-size: 0.9em;
        font-weight: 500;
    }

    /* Empty States */
    .empty-state {
        text-align: center;
        padding: 50px 20px;
        color: var(--text-muted);
    }

    .empty-state i {
        font-size: 3.5em;
        margin-bottom: 20px;
        opacity: 0.5;
    }

    .empty-state p {
        margin-bottom: 10px;
        font-size: 1.1em;
    }

    .empty-state small {
        font-size: 0.9em;
    }

    /* Highlight Tools */
    .highlight-tools {
        position: fixed;
        background: var(--card-bg);
        border: 2px solid var(--gold);
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.6);
        z-index: 10000;
        display: none;
        flex-direction: column;
        gap: 15px;
        min-width: 280px;
        backdrop-filter: blur(10px);
    }

    .highlight-tools.show {
        display: flex;
        animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(20px) scale(0.95);
        }
        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }

    .tools-header {
        color: var(--gold);
        font-weight: 700;
        font-size: 1.1em;
        text-align: center;
        padding-bottom: 10px;
        border-bottom: 2px solid var(--border);
    }

    /* Utility Classes */
    .text-success { color: var(--success); }
    .text-warning { color: var(--warning); }
    .text-error { color: var(--error); }
    .text-info { color: var(--info); }
    .text-gold { color: var(--gold); }

    .bg-success { background: var(--success); }
    .bg-warning { background: var(--warning); }
    .bg-error { background: var(--error); }
    .bg-info { background: var(--info); }
</style>
{% endblock %}

{% block content %}
<div class="moderation-layout">
    <!-- Header -->
    <div class="moderation-header">
        <h1 class="article-title">{{ article.title }}</h1>
        <div class="article-meta-grid">
            <div class="meta-card">
                <div class="meta-icon">üë§</div>
                <div class="meta-label">–ê–≤—Ç–æ—Ä</div>
                <div class="meta-value">{{ article.author.username }}</div>
            </div>
            <div class="meta-card">
                <div class="meta-icon">üìÖ</div>
                <div class="meta-label">–°–æ–∑–¥–∞–Ω–æ</div>
                <div class="meta-value">{{ article.created_at|date:"d.m.Y H:i" }}</div>
            </div>
            <div class="meta-card">
                <div class="meta-icon">üè∑Ô∏è</div>
                <div class="meta-label">–°—Ç–∞—Ç—É—Å</div>
                <div class="meta-value">{{ article.get_status_display }}</div>
            </div>
            <div class="meta-card">
                <div class="meta-icon">üí¨</div>
                <div class="meta-label">–ó–∞–º–µ—á–∞–Ω–∏—è</div>
                <div class="meta-value">{{ moderation_comments|length }}</div>
            </div>
        </div>
    </div>

    <!-- –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å - –∫–æ–Ω—Ç–µ–Ω—Ç —Å—Ç–∞—Ç—å–∏ -->
    <div class="content-panel">
        <div class="content-controls">
            <div class="highlight-controls">
                <button id="toggleHighlight" class="toggle-highlight">
                    <i class="fas fa-highlighter"></i>
                    <span>–†–µ–∂–∏–º –≤—ã–¥–µ–ª–µ–Ω–∏—è</span>
                </button>
                <span id="highlightStatus" class="highlight-status">
                    –í—ã–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–∫–ª—é—á–µ–Ω–æ
                </span>
            </div>
        </div>

        <div id="contentArea" class="content-area">
            {{ article.content|safe }}
        </div>

        <!-- Progress Bar -->
        <div class="progress-section">
            <div class="progress-header">
                <div class="progress-title">–ü—Ä–æ–≥—Ä–µ—Å—Å –º–æ–¥–µ—Ä–∞—Ü–∏–∏</div>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"
                     style="width: {% with resolved=moderation_comments|length %}{% if resolved > 0 %}100{% else %}0{% endif %}%{% endwith %}">
                </div>
            </div>
            <div class="progress-text">
                <span>–í—ã–ø–æ–ª–Ω–µ–Ω–æ</span>
                <span id="progressText">
                    {% if moderation_comments|length > 0 %}100%{% else %}0%{% endif %}
                </span>
            </div>
        </div>
    </div>

    <!-- –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å - –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∏ –¥–µ–π—Å—Ç–≤–∏—è -->
    <div class="sidebar">
        <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è -->
        <div class="sidebar-section">
            <div class="section-header">
                <i class="fas fa-comment-medical section-icon"></i>
                <h3 class="section-title">–ù–æ–≤–æ–µ –∑–∞–º–µ—á–∞–Ω–∏–µ</h3>
            </div>
            <form id="commentForm" class="comment-form">
                {% csrf_token %}
                <input type="hidden" id="highlightedText" name="highlighted_text">
                <input type="hidden" id="startPosition" name="start_position">
                <input type="hidden" id="endPosition" name="end_position">
                <input type="hidden" id="selectionContext" name="selection_context">

                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-text-height"></i>
                        –í—ã–¥–µ–ª–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç:
                    </label>
                    <div id="selectedTextPreview" class="selected-text-preview">
                        –í—ã–¥–µ–ª–∏—Ç–µ —Ç–µ–∫—Å—Ç –≤ —Å—Ç–∞—Ç—å–µ...
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-exclamation-triangle"></i>
                        –í–∞–∂–Ω–æ—Å—Ç—å:
                    </label>
                    <div class="severity-selector">
                        <div class="severity-option severity-low" data-severity="low">
                            <i class="fas fa-lightbulb"></i>
                            –ù–∏–∑–∫–∞—è
                        </div>
                        <div class="severity-option severity-medium selected" data-severity="medium">
                            <i class="fas fa-exclamation-circle"></i>
                            –°—Ä–µ–¥–Ω—è—è
                        </div>
                        <div class="severity-option severity-high" data-severity="high">
                            <i class="fas fa-skull-crossbones"></i>
                            –í—ã—Å–æ–∫–∞—è
                        </div>
                        <div class="severity-option severity-critical" data-severity="critical">
                            <i class="fas fa-bomb"></i>
                            –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è
                        </div>
                    </div>
                    <input type="hidden" id="severity" name="severity" value="medium">
                </div>

                <div class="form-group">
                    <label class="form-label" for="comment">
                        <i class="fas fa-comment-dots"></i>
                        –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:
                    </label>
                    <textarea id="comment" name="comment" class="form-control"
                              placeholder="–û–ø–∏—à–∏—Ç–µ –ø—Ä–æ–±–ª–µ–º—É –∏–ª–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ..." required></textarea>
                </div>

                <button type="submit" class="action-btn" style="background: var(--gold); color: var(--dark-bg);">
                    <i class="fas fa-plus-circle"></i>
                    –î–æ–±–∞–≤–∏—Ç—å –∑–∞–º–µ—á–∞–Ω–∏–µ
                </button>
            </form>
        </div>

        <!-- –°–ø–∏—Å–æ–∫ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ -->
        <div class="sidebar-section">
            <div class="section-header">
                <i class="fas fa-comments section-icon"></i>
                <h3 class="section-title">–ó–∞–º–µ—á–∞–Ω–∏—è</h3>
                <span class="section-badge">{{ moderation_comments|length }}</span>
            </div>
            <div class="comments-list" id="commentsList">
                {% for comment in moderation_comments %}
                <div class="comment-item {% if comment.status == 'resolved' %}resolved{% endif %}"
                     data-comment-id="{{ comment.id }}">
                    <div class="comment-header">
                        <div class="comment-severity" style="color: {{ comment.get_severity_color }};">
                            <i class="fas fa-exclamation-circle"></i>
                            {{ comment.get_severity_display }}
                        </div>
                        <span class="comment-date">{{ comment.created_at|date:"d.m.Y H:i" }}</span>
                    </div>

                    {% if comment.highlighted_text %}
                    <div class="comment-context">
                        <strong>–í—ã–¥–µ–ª–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç:</strong> "{{ comment.highlighted_text }}"
                    </div>
                    {% endif %}

                    <div class="comment-text">
                        {{ comment.comment }}
                    </div>

                    <div class="comment-meta">
                        <span>–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä: {{ comment.moderator.username }}</span>
                        {% if comment.status == 'resolved' %}
                            <span class="text-success">‚úì –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ</span>
                        {% else %}
                            <span class="text-warning">‚è≥ –û–∂–∏–¥–∞–µ—Ç</span>
                        {% endif %}
                    </div>

                    {% if comment.status != 'resolved' %}
                    <div class="comment-actions">
                        <button class="btn btn-resolve" onclick="resolveComment({{ comment.id }})">
                            <i class="fas fa-check"></i> –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ
                        </button>
                        <button class="btn btn-delete" onclick="deleteComment({{ comment.id }})">
                            <i class="fas fa-trash"></i> –£–¥–∞–ª–∏—Ç—å
                        </button>
                    </div>
                    {% endif %}
                </div>
                {% empty %}
                <div class="empty-state">
                    <i class="fas fa-inbox"></i>
                    <p>–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–º–µ—á–∞–Ω–∏–π</p>
                    <small>–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤–æ–µ –∑–∞–º–µ—á–∞–Ω–∏–µ, –≤—ã–¥–µ–ª–∏–≤ —Ç–µ–∫—Å—Ç –≤ —Å—Ç–∞—Ç—å–µ</small>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- –î–µ–π—Å—Ç–≤–∏—è –º–æ–¥–µ—Ä–∞—Ü–∏–∏ -->
        <div class="sidebar-section">
            <div class="section-header">
                <i class="fas fa-gavel section-icon"></i>
                <h3 class="section-title">–†–µ—à–µ–Ω–∏–µ –ø–æ —Å—Ç–∞—Ç—å–µ</h3>
            </div>
            <div class="moderation-actions">
                <form method="post" class="moderation-form">
                    {% csrf_token %}
                    <input type="hidden" name="action" id="moderationAction">

                    <div class="form-group">
                        <label class="form-label" for="moderation_notes">
                            <i class="fas fa-sticky-note"></i>
                            –û–±—â–∏–µ –∑–∞–º–µ—Ç–∫–∏:
                        </label>
                        <textarea name="moderation_notes" class="form-control"
                                  placeholder="–û–±—â–∏–µ –∑–∞–º–µ—á–∞–Ω–∏—è –ø–æ —Å—Ç–∞—Ç—å–µ...">{{ article.moderation_notes }}</textarea>
                    </div>

                    <button type="submit" name="action" value="approve" class="action-btn btn-approve">
                        <i class="fas fa-check-circle"></i>
                        –û–¥–æ–±—Ä–∏—Ç—å —Å—Ç–∞—Ç—å—é
                    </button>

                    <button type="submit" name="action" value="needs_correction" class="action-btn btn-correction">
                        <i class="fas fa-edit"></i>
                        –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ –¥–æ—Ä–∞–±–æ—Ç–∫—É
                    </button>

                    <button type="submit" name="action" value="send_to_editor" class="action-btn btn-editor">
                        <i class="fas fa-user-edit"></i>
                        –ü–µ—Ä–µ–¥–∞—Ç—å —Ä–µ–¥–∞–∫—Ç–æ—Ä—É
                    </button>

                    <button type="submit" name="action" value="reject" class="action-btn btn-reject">
                        <i class="fas fa-times-circle"></i>
                        –û—Ç–∫–ª–æ–Ω–∏—Ç—å —Å—Ç–∞—Ç—å—é
                    </button>
                </form>
            </div>
        </div>

        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div class="sidebar-section">
            <div class="section-header">
                <i class="fas fa-chart-bar section-icon"></i>
                <h3 class="section-title">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
            </div>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-number" id="openCommentsCount">
                        {{ moderation_comments|length }}
                    </div>
                    <div class="stat-label">–í—Å–µ–≥–æ –∑–∞–º–µ—á–∞–Ω–∏–π</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="resolvedCommentsCount">
                        {% with resolved=moderation_comments|length %}{{ resolved }}{% endwith %}
                    </div>
                    <div class="stat-label">–ê–∫—Ç–∏–≤–Ω—ã–µ</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –ü–∞–Ω–µ–ª—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –≤—ã–¥–µ–ª–µ–Ω–∏—è -->
<div id="highlightTools" class="highlight-tools">
    <div class="tools-header">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–º–µ—á–∞–Ω–∏–µ</div>
    <div id="toolsTextPreview" class="selected-text-preview"></div>
    <button id="addCommentBtn" class="btn" style="background: var(--gold); color: var(--dark-bg); border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 1em;">
        <i class="fas fa-plus"></i> –î–æ–±–∞–≤–∏—Ç—å –∑–∞–º–µ—á–∞–Ω–∏–µ
    </button>
</div>

<script>
// –û—Å–Ω–æ–≤–Ω–æ–π JavaScript –∫–æ–¥ –¥–ª—è —Å–∏—Å—Ç–µ–º—ã –≤—ã–¥–µ–ª–µ–Ω–∏—è –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
document.addEventListener('DOMContentLoaded', function() {
    const contentArea = document.getElementById('contentArea');
    const toggleHighlightBtn = document.getElementById('toggleHighlight');
    const highlightStatus = document.getElementById('highlightStatus');
    const highlightTools = document.getElementById('highlightTools');
    const toolsTextPreview = document.getElementById('toolsTextPreview');
    const addCommentBtn = document.getElementById('addCommentBtn');
    const commentForm = document.getElementById('commentForm');
    const selectedTextPreview = document.getElementById('selectedTextPreview');
    const severityOptions = document.querySelectorAll('.severity-option');
    const severityInput = document.getElementById('severity');

    let isHighlightMode = false;
    let currentSelection = null;

    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞ –≤—ã–¥–µ–ª–µ–Ω–∏—è
    toggleHighlightBtn.addEventListener('click', function() {
        isHighlightMode = !isHighlightMode;

        if (isHighlightMode) {
            contentArea.classList.add('highlight-mode');
            highlightStatus.textContent = '–í—ã–¥–µ–ª–µ–Ω–∏–µ –≤–∫–ª—é—á–µ–Ω–æ - –≤—ã–¥–µ–ª—è–π—Ç–µ —Ç–µ–∫—Å—Ç';
            highlightStatus.style.color = 'var(--gold)';
            toggleHighlightBtn.classList.add('active');
            toggleHighlightBtn.innerHTML = '<i class="fas fa-highlighter"></i><span>–í—ã–∫–ª—é—á–∏—Ç—å –≤—ã–¥–µ–ª–µ–Ω–∏–µ</span>';
        } else {
            contentArea.classList.remove('highlight-mode');
            highlightStatus.textContent = '–í—ã–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–∫–ª—é—á–µ–Ω–æ';
            highlightStatus.style.color = 'var(--text-muted)';
            toggleHighlightBtn.classList.remove('active');
            toggleHighlightBtn.innerHTML = '<i class="fas fa-highlighter"></i><span>–†–µ–∂–∏–º –≤—ã–¥–µ–ª–µ–Ω–∏—è</span>';
            hideHighlightTools();
        }
    });

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–¥–µ–ª–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞
    contentArea.addEventListener('mouseup', function(e) {
        if (!isHighlightMode) return;

        const selection = window.getSelection();
        const selectedText = selection.toString().trim();

        if (selectedText.length > 0 && selectedText.length < 1000) {
            currentSelection = selection;
            showHighlightTools(e.pageX, e.pageY, selectedText);

            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É
            document.getElementById('highlightedText').value = selectedText;
            selectedTextPreview.textContent = selectedText;
            toolsTextPreview.textContent = selectedText;
        } else if (selectedText.length >= 1000) {
            showNotification('–°–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π –≤—ã–¥–µ–ª–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç. –ú–∞–∫—Å–∏–º—É–º 1000 —Å–∏–º–≤–æ–ª–æ–≤.', 'warning');
            selection.removeAllRanges();
        }
    });

    // –ü–æ–∫–∞–∑ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –≤—ã–¥–µ–ª–µ–Ω–∏—è
    function showHighlightTools(x, y, text) {
        const viewportWidth = window.innerWidth;
        const viewportHeight = window.innerHeight;
        const toolsWidth = highlightTools.offsetWidth;
        const toolsHeight = highlightTools.offsetHeight;

        // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã, —á—Ç–æ–±—ã –æ–Ω–∏ –Ω–µ –≤—ã—Ö–æ–¥–∏–ª–∏ –∑–∞ –≥—Ä–∞–Ω–∏—Ü—ã —ç–∫—Ä–∞–Ω–∞
        let left = x + 10;
        let top = y + 10;

        if (left + toolsWidth > viewportWidth - 20) {
            left = viewportWidth - toolsWidth - 20;
        }
        if (top + toolsHeight > viewportHeight - 20) {
            top = viewportHeight - toolsHeight - 20;
        }

        highlightTools.style.left = left + 'px';
        highlightTools.style.top = top + 'px';
        highlightTools.classList.add('show');
    }

    function hideHighlightTools() {
        highlightTools.classList.remove('show');
        if (currentSelection) {
            currentSelection.removeAllRanges();
            currentSelection = null;
        }
    }

    // –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è –∏–∑ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
    addCommentBtn.addEventListener('click', function() {
        hideHighlightTools();
        // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ —Ñ–æ—Ä–º–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
        document.querySelector('.sidebar').scrollIntoView({ behavior: 'smooth' });
        document.getElementById('comment').focus();
    });

    // –í—ã–±–æ—Ä –≤–∞–∂–Ω–æ—Å—Ç–∏
    severityOptions.forEach(option => {
        option.addEventListener('click', function() {
            severityOptions.forEach(opt => opt.classList.remove('selected'));
            this.classList.add('selected');
            severityInput.value = this.dataset.severity;
        });
    });

    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
    commentForm.addEventListener('submit', function(e) {
        e.preventDefault();

        const formData = new FormData(this);
        const highlightedText = formData.get('highlighted_text');
        const commentText = formData.get('comment');

        if (!highlightedText || highlightedText === '') {
            showNotification('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–¥–µ–ª–∏—Ç–µ —Ç–µ–∫—Å—Ç –≤ —Å—Ç–∞—Ç—å–µ –ø–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º –∑–∞–º–µ—á–∞–Ω–∏—è.', 'warning');
            return;
        }

        if (!commentText.trim()) {
            showNotification('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π.', 'warning');
            return;
        }

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        const submitBtn = commentForm.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –î–æ–±–∞–≤–ª–µ–Ω–∏–µ...';
        submitBtn.disabled = true;

        // AJAX –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã
        fetch('{% url "wiki:add_moderation_comment" article.slug %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'X-Requested-With': 'XMLHttpRequest',
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
                commentForm.reset();
                selectedTextPreview.textContent = '–í—ã–¥–µ–ª–∏—Ç–µ —Ç–µ–∫—Å—Ç –≤ —Å—Ç–∞—Ç—å–µ...';
                severityInput.value = 'medium';
                severityOptions.forEach(opt => {
                    if (opt.dataset.severity === 'medium') {
                        opt.classList.add('selected');
                    } else {
                        opt.classList.remove('selected');
                    }
                });

                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
                location.reload();
                showNotification('–ó–∞–º–µ—á–∞–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ!', 'success');
            } else {
                showNotification('–û—à–∏–±–∫–∞: ' + data.error, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∑–∞–º–µ—á–∞–Ω–∏—è', 'error');
        })
        .finally(() => {
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        });
    });

    function showNotification(message, type) {
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 24px;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            z-index: 10000;
            animation: slideInRight 0.3s ease-out;
            display: flex;
            align-items: center;
            gap: 12px;
            max-width: 400px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.4);
            font-size: 1em;
        `;

        const bgColor = type === 'success' ? '#22c55e' :
                       type === 'error' ? '#ef4444' :
                       type === 'warning' ? '#f59e0b' : '#3b82f6';

        notification.style.background = bgColor;

        const icon = type === 'success' ? '‚úÖ' :
                    type === 'error' ? '‚ùå' :
                    type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';

        notification.innerHTML = `
            <span style="font-size: 1.3em;">${icon}</span>
            <span>${message}</span>
        `;

        document.body.appendChild(notification);

        setTimeout(() => {
            notification.style.animation = 'slideOutRight 0.3s ease-in';
            setTimeout(() => {
                notification.remove();
            }, 300);
        }, 4000);
    }

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –∏—Ö
    document.addEventListener('click', function(e) {
        if (!highlightTools.contains(e.target) && e.target !== contentArea) {
            hideHighlightTools();
        }
    });

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∞–≤–∏—à
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            isHighlightMode = false;
            contentArea.classList.remove('highlight-mode');
            highlightStatus.textContent = '–í—ã–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–∫–ª—é—á–µ–Ω–æ';
            highlightStatus.style.color = 'var(--text-muted)';
            toggleHighlightBtn.classList.remove('active');
            toggleHighlightBtn.innerHTML = '<i class="fas fa-highlighter"></i><span>–†–µ–∂–∏–º –≤—ã–¥–µ–ª–µ–Ω–∏—è</span>';
            hideHighlightTools();
        }
    });

    // –ê–Ω–∏–º–∞—Ü–∏–∏ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        @keyframes slideOutRight {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(100%);
            }
        }
    `;
    document.head.appendChild(style);
});

// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏
function resolveComment(commentId) {
    fetch(`{% url "wiki:resolve_moderation_comment" 0 %}`.replace('0', commentId), {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'X-Requested-With': 'XMLHttpRequest',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
            showNotification('–ó–∞–º–µ—á–∞–Ω–∏–µ –ø–æ–º–µ—á–µ–Ω–æ –∫–∞–∫ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–µ!', 'success');
        } else {
            showNotification('–û—à–∏–±–∫–∞: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∑–∞–º–µ—á–∞–Ω–∏—è', 'error');
    });
}

function deleteComment(commentId) {
    if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ –∑–∞–º–µ—á–∞–Ω–∏–µ?')) return;

    fetch(`{% url "wiki:delete_moderation_comment" 0 %}`.replace('0', commentId), {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'X-Requested-With': 'XMLHttpRequest',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
            showNotification('–ó–∞–º–µ—á–∞–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ!', 'success');
        } else {
            showNotification('–û—à–∏–±–∫–∞: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∑–∞–º–µ—á–∞–Ω–∏—è', 'error');
    });
}

function showNotification(message, type) {
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Ñ—É–Ω–∫—Ü–∏—é showNotification –∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞
    if (typeof showNotification === 'function') {
        window.showNotification(message, type);
    } else {
        // –ü—Ä–æ—Å—Ç–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è, –µ—Å–ª–∏ —Ñ—É–Ω–∫—Ü–∏—è –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞
        alert(message);
    }
}
</script>
{% endblock %}